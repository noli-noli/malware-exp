from sklearn.metrics import confusion_matrix
from sklearn.metrics import accuracy_score
from sklearn.model_selection import train_test_split
from lightgbm import LGBMClassifier
import pickle
import os
import pandas as pd
import matplotlib.pyplot as plot

#ランダムフォレストを使用した機械学習モデル


##### データセットの読込 #####
#データセットのパッチを指定
dataset = os.path.join("..","..","dataset","MalwareData.csv")
#データセットの読込
MalwareDataset = pd.read_csv(dataset,sep='|')
#MalwareDatasetからname,md5,legitimateを除外してXに格納する
X = MalwareDataset.drop(["Name","md5","legitimate"],axis="columns")
#legitimateをyに格納する
y = MalwareDataset["legitimate"]
#モデルファイルの名前
modelname = "LightGBM.pickle"
#########


##### データセットの分割 #####
# データセットを訓練用とテスト用に分割
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, shuffle=True, random_state=101
    )
##########


def main():
    if os.path.exists(modelname):
        print("found model")
        test()
    else:
        print("not found model")
        train()
        
         
def test():
    print("model test")
    with open(modelname, mode='rb') as f:
        model = pickle.load(f)
        print("model loaed")
    
    # テスト用のデータを使用して予測
    pred = model.predict(X_test)

    # 予測結果とテスト用のデータを使って正解率と、混同行列を出力
    print("Accuracy: {:.5f} %".format(100 * accuracy_score(y_test, pred)))
    print(confusion_matrix(y_test, pred))

    feat_importances = pd.Series(model.feature_importances_, index=X.columns).sort_values(ascending=True)
    feat_importances.plot(kind='barh',figsize=(10,5))
    plot.tight_layout()
    plot.savefig(f"LightGBM.png",dpi=200)

    return 0



def train():
    print("model train")
    # optunaの探索結果として得られたベストのパラメータを設定
    model = LGBMClassifier(
        learning_rate=0.9,
        boosting_type="goss",
        max_depth=8,
    )

    # モデルの訓練
    model.fit(X_train, y_train)

    # モデルの保存
    with open(modelname, mode='wb') as f:
        pickle.dump(model, f,protocol=2)
        print("model saved")
    
    test()

if __name__ == "__main__":
    main()