import pandas as pd
import numpy as np
import matplotlib.pyplot as plot
import sklearn
import os
from sklearn.feature_selection import SelectFromModel
from sklearn.ensemble import ExtraTreesClassifier
from sklearn.model_selection import train_test_split
from sklearn import model_selection



##### データセットの読込 #####
#データセットのパッチを指定
dataset = os.path.join("..","..","dataset","MalwareData.csv")
#データセットの読込
MalwareDataset = pd.read_csv(dataset,sep='|')
#MalwareDatasetからname,md5,legitimateを除外してXに格納する
X = MalwareDataset.drop(["Name","md5","legitimate"],axis="columns")
#legitimateをyに格納する
y = MalwareDataset["legitimate"]
##########



##### 学習 ####
#ExtraTreesClassifierを指定し、Xとyを目的変数及び説明変数として指定する。
FeastSelect = ExtraTreesClassifier().fit(X,y)
#FeastSelectをモデルにする。また、prefitで外部で学習された特徴選択モデルを再利用するオプションを指定する。
Model = SelectFromModel(FeastSelect,prefit=True)
##########



##### 特徴量の重要度を出力 #####
# 重要度の大きい特徴量のカラム名を取得
feature_idx = Model.get_support()
feature_name = X.columns[feature_idx]
# Xに選択した特徴量のみを代入しなおす
X = Model.transform(X)
# 重要度の大きい特徴量のカラム名を設定
X = pd.DataFrame(X)
X.columns = feature_name
Features = X.shape[1]
# 重要度をリストで抽出
FI = ExtraTreesClassifier().fit(X,y).feature_importances_
# 重要度を高い順にソート
Index = np.argsort(FI)[::-1][:Features]
# 重要度の高い順に、特徴量の名前と重要度を出力
for feat  in range(Features):
    print(
        "Feature: {}Importance: {:.5f}"\
          .format(MalwareDataset.columns[2+Index[feat]].ljust(30),
                  FI[Index[feat]])
          )
##########
